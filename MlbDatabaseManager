package org.example;

import java.io.FileWriter;
import java.io.IOException;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.util.*;

import java.util.HashSet;

/**
 * Manages the connection to the MLB database and updates player statistics.
 */
public class MlbDatabaseManager {
    private static final String DATABASE_PATH = "jdbc:sqlite:MLBdatabase.db";

    //private Connection connection; // Connection for the database


    /**
     * Constructs an instance of MlbDatabaseManager, establishes a connection to the database,
     * and initializes the web scraping API.
     */
    private Connection ConnectToDataBase() {
        Connection connection = null;
        try {
            // Load the SQLite JDBC driver
            Class.forName("org.sqlite.JDBC");

            // Connect to the database
            connection = DriverManager.getConnection(DATABASE_PATH);

            System.out.println("Connected to the MLB database.");

            // Initialize the web scraping API
        } catch (ClassNotFoundException | SQLException e) {
            e.printStackTrace();
        }
        return connection;
    }


    public void makeCSV(){
        MlbAPI scraper = new MlbAPI();
        boolean getPlayerStats = true; //temporarily set to false
        if(getPlayerStats) {

            int pitcherFlag = 0, hitterFlag = 0;
            Vector<String> pitchersSeason = new Vector<>(), hittersSeason = new Vector<>(), pitchersCareer = new Vector<>(), hittersCareer = new Vector<>(),
                    pitchersGameLogs = new Vector<>(), hittersGameLogs = new Vector<>();
            List<String> hitterLogs = new ArrayList();
            List<String> pitcherLogs = new ArrayList<>();
            ;
            List teams = scraper.updateStatsSeasonCareer();
            for (Object team : teams) {
                String playerName = "";


                for (Object player : (List) team) {
                    List<?> playerStats = (List<?>) player;
                    String checkString = (String) playerStats.get(playerStats.size() - 1);

                    if (!checkString.contains("Minors Career")) {
                        checkString = (String) playerStats.get(0);

                        if (checkString.contains("AB")) {
                            addDataToVector(playerStats, hittersSeason, hittersCareer, hitterFlag);
                            hitterFlag = 1;
                        } else {
                            addDataToVector(playerStats, pitchersSeason, pitchersCareer, pitcherFlag);
                            pitcherFlag = 1;
                        }
                    }
                }
                // Write the collected data to files
                writeDataToFile("hittersSeason.csv", hittersSeason);
                writeDataToFile("hittersCareer.csv", hittersCareer);
                writeDataToFile("pitchersSeason.csv", pitchersSeason);
                writeDataToFile("pitchersCareer.csv", pitchersCareer);
            }

//            hitterFlag = 0;
//            pitcherFlag = 0;
//            for (Object player : (List) hitting) {
//                List<?> playerStats = (List<?>) player;
//                addDataToVector(playerStats, hittersGameLogs, hittersCareer, hitterFlag);
//                hitterFlag = 1;
//            }
//            for (Object player : (List) pitching) {
//                List<?> playerStats = (List<?>) player;
//                addDataToVector(playerStats, pitchersGameLogs, hittersCareer, pitcherFlag);
//                pitcherFlag = 1;
//            }
            teams = scraper.updateGameLogs();
            for (Object team : teams) {
                String playerName = "";


                for (Object player : (List) team) {
                    List<?> playerStats = (List<?>) player;
                    String checkString = (String) playerStats.get(playerStats.size() - 1);

                    if (!checkString.contains("Minors Career")) {
                        checkString = (String) playerStats.get(0);

                        if (checkString.contains("AB")) {
                            addDataToVector(playerStats, hittersGameLogs, hittersCareer, hitterFlag);
                            hitterFlag = 1;
                        } else {
                            addDataToVector(playerStats, pitchersGameLogs, pitchersCareer, pitcherFlag);
                            pitcherFlag = 1;
                        }
                    }
                }
                // Write the collected data to files
                writeDataToFile("hittingGameLogs.csv", hittersGameLogs);
                writeDataToFile("pitchingGameLogs.csv", pitchersGameLogs);
            }

        }
        scraper.fetchTeamStats() ;


    }

    /**
     * Writes data to a file with the specified name.
     *
     * @param fileName The name of the file.
     * @param data     The data to be written to the file.
     */
    private void writeDataToFile(String fileName, Vector<String> data) {
        try (FileWriter fileWriter = new FileWriter(fileName)) {
            for (String line : data) {
                fileWriter.write(line);
                fileWriter.write(System.lineSeparator());
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    /**
     * Adds player statistics to the specified vector.
     *
     * @param playerStats The statistics of the player.
     * @param seasons      The vector to which the season stat line data should be added.
     * @param careers      The vector to which the career stat line data should be added.
     * @param flag        The flag indicating the current state.
     */
    private String addDataToVector(List<?> playerStats, Vector<String> seasons,Vector<String> careers, int flag) {
        for (Object line : playerStats.subList(flag, playerStats.size() - 1)) {
            seasons.add((String) line);
        }
        if(flag == 0)
            careers.add((String) playerStats.get(0));
        careers.add((String) playerStats.get(playerStats.size()-1));
        String playerNameAndId = (String) playerStats.get(1);
        String playerNameAndIdArr[] = playerNameAndId.split(",");
        playerNameAndId = playerNameAndIdArr[0] + "," + playerNameAndIdArr[1] ;
        return playerNameAndId.toLowerCase() ;
    }
//    public boolean UpDateDatabase(List CSV){
//      Connection connection = ConnectToDataBase() ;
//        try (Connection connection = DriverManager.getConnection(databaseUrl);
//             Statement statement = connection.createStatement()) {
//
//            // Create the table if it doesn't exist
//            statement.execute("CREATE TABLE IF NOT EXISTS " + tableName + "(column1 TEXT, column2 TEXT, ...)");
//
//            // Import data from CSV
//            String importCsvQuery = "INSERT INTO " + tableName + " SELECT * FROM CSVREAD('" + csvFilePath + "');";
//            statement.execute(importCsvQuery);
//
//            System.out.println("CSV data imported successfully.");
//
//        } catch (Exception e) {
//            e.printStackTrace();
//        }
}

/**
 * Closes resources.
 */
//    public void closeResources() {
//        // Close the web scraping API
//        if (scraper != null) {
//            scraper.close(); // Assuming MlbAPI implements AutoCloseable or Closeable
//        }
//    }
